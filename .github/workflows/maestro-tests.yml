name: Maestro UI Tests

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to test (ios/android)'
        required: true
        type: choice
        options:
          - ios
          - android
      app_url:
        description: 'URL to download the app binary (.app/.apk)'
        required: true
      test_tag:
        description: 'Test tag to run (e.g., searchTests)'
        required: true
        default: 'searchTests'

jobs:
  mobile-test:
    name: Run ${{ github.event.inputs.platform }} UI Tests
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "${HOME}/.maestro/bin" >> $GITHUB_PATH

      # iOS specific setup
      - name: Setup iOS dependencies
        if: github.event.inputs.platform == 'ios'
        run: |
          # Setup Xcode
          sudo xcode-select --switch /Applications/Xcode.app
          xcrun simctl list devices

      # Android specific setup
      - name: Setup Android dependencies
        if: github.event.inputs.platform == 'android'
        run: |
          # Setup Android SDK
          echo "y" | sdkmanager "platform-tools" "platforms;android-31" "build-tools;31.0.0"
          echo "y" | sdkmanager --licenses

      - name: Create required directories
        run: |
          mkdir -p artifacts
          mkdir -p reports

      # Platform specific app download and setup
      - name: Setup iOS app
        if: github.event.inputs.platform == 'ios'
        run: |
          # Start simulator first and ensure it's ready
          DEVICE_ID=$(xcrun xctrace list devices | grep -m 1 "iPhone" | awk '{print $NF}' | tr -d '()')
          xcrun simctl boot "${DEVICE_ID:?No iPhone simulator found}"
          
          # Wait for simulator to be fully ready
          echo "Waiting for simulator to be ready..."
          xcrun simctl list devices | grep Booted
          
          # Set status bar with correct time format
          xcrun simctl status_bar "$DEVICE_ID" override --time "12:00:00" --dataNetwork wifi
          
          # Now download and install the app
          curl -L "${{ github.event.inputs.app_url }}" -o artifacts/app.zip
          cd artifacts && unzip app.zip && rm app.zip
          
          # Only rename if needed
          if [ ! -d "Alfie.app" ] && [ -n "$(find . -name '*.app' ! -name 'Alfie.app')" ]; then
            mv *.app Alfie.app
          fi
          
          # Install the app
          echo "Installing app..."
          xcrun simctl install booted "Alfie.app"
          
          # Verify installation
          if xcrun simctl get_app_container booted "com.mindera.alfie.debug" > /dev/null 2>&1; then
            echo "✅ App installed successfully"
          else
            echo "❌ Failed to install app"
            echo "App container contents:"
            xcrun simctl get_app_container booted "com.mindera.alfie.debug" || true
            echo "Simulator apps:"
            xcrun simctl listapps booted
            exit 1
          fi


      - name: Setup Android app
        if: github.event.inputs.platform == 'android'
        run: |
          curl -L "${{ github.event.inputs.app_url }}" -o artifacts/Alfie.apk
          
          # Start emulator
          echo "y" | sdkmanager "system-images;android-31;google_apis;x86_64"
          echo "no" | avdmanager create avd -n test -k "system-images;android-31;google_apis;x86_64"
          $ANDROID_HOME/emulator/emulator -avd test -no-audio -no-window &
          adb wait-for-device

      - name: Give permission to run script
        run: chmod +x scripts/run-tests.sh

      - name: Run Maestro tests
        env:
          MAESTRO_CLI_NO_ANALYTICS: "true"
          MAESTRO_CLI_ANALYSIS_NOTIFICATION_DISABLED: "true"
        run: |
          mkdir -p reports
          ./scripts/run-tests.sh ${{ github.event.inputs.platform }} ${{ github.event.inputs.test_tag }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.platform }}-test-results
          path: reports/
          retention-days: 30 